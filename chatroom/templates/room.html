<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{room}} · Chat</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    :root { --bg:#0a0f1a; --panel:#0f1522; --text:#e6eaf2; --muted:#9aa6b2; --primary:#4f8cff; }
    body.light { --bg:#f5f7fb; --panel:#ffffff; --text:#0f172a; --muted:#5b6773; --primary:#2f6bff; }
    html, body { height:100%; }
    body { margin:0; background:linear-gradient(180deg, #0b1220, #0f172a); color:var(--text); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body.light { background:#eef2ff; }
    .app { display:flex; flex-direction:column; height:100%; max-width:900px; margin:0 auto; }
    .app-header { display:flex; align-items:center; justify-content:space-between; padding:16px 12px; }
    .brand { display:flex; align-items:center; gap:10px; font-weight:600; }
    .brand .material-icons { color:#60a5fa; }
    .card { background:linear-gradient(180deg, var(--panel), #0b1020); border-radius:16px; border:1px solid rgba(0,0,0,0.06); box-shadow:0 10px 30px rgba(0,0,0,.15); }
    .messages { flex:1; overflow:auto; padding:16px; }
    .msg { display:flex; align-items:flex-end; gap:10px; margin-bottom:12px; }
    .msg.me { justify-content:flex-end; }
    .avatar { width:32px; height:32px; border-radius:50%; background:#1f2937; color:#e5e7eb; display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:600; border:1px solid rgba(0,0,0,0.1); }
    body.light .avatar { background:#e5e7eb; color:#111827; }
    .bubble { max-width:68%; padding:10px 12px; border-radius:14px; border:1px solid rgba(0,0,0,0.06); background:var(--panel); }
    .bubble .meta { display:flex; justify-content:space-between; color:var(--muted); font-size:.8rem; margin-bottom:4px; }
    .msg.me .bubble { background:linear-gradient(135deg, #4f8cff, #2f6bff); color:white; border-color:transparent; }
    .msg.me .bubble .meta { color:rgba(255,255,255,0.85); }
    .composer { position:sticky; bottom:0; background:var(--panel); display:flex; gap:8px; padding:12px; border-top:1px solid rgba(255,255,255,0.06); }
    .composer .input-field { flex:1; margin:0; }
    .composer input { color:var(--text); }
    .composer input:focus { border-bottom:1px solid var(--primary) !important; box-shadow:0 1px 0 0 var(--primary) !important; }
    .btn-primary { background:linear-gradient(135deg, #3b82f6, #2563eb); border-radius:10px; text-transform:none; height:44px; line-height:44px; box-shadow:0 8px 20px rgba(37,99,235,.35); }
    .theme-toggle { color:var(--muted); display:flex; align-items:center; gap:6px; cursor:pointer; }
    .typing { color:var(--muted); font-size:.9rem; padding:0 16px 8px; min-height:22px; }
    .upload { width:44px; height:44px; border-radius:10px; background:#1f2937; display:flex; align-items:center; justify-content:center; cursor:pointer; border:1px solid rgba(0,0,0,0.1); }
    body.light .upload { background:#eef2ff; }
    .thumb { margin-top:8px; }
  </style>
</head>
<body>
  <div class="app">
    <header class="app-header">
      <div class="brand">
        <span class="material-icons">chat_bubble_outline</span>
        <span>{{room}}</span>
      </div>
      <div class="right" style="display:flex; align-items:center; gap:12px; color:#9ca3af;">
        <span class="theme-toggle" id="themeToggle"><span class="material-icons">brightness_6</span><span id="themeLabel">Dark</span></span>
        <span>Signed in as {{username}}</span>
      </div>
    </header>

    <section class="card" style="display:flex; flex-direction:column; min-height:60vh;">
      <div id="display" class="messages"></div>
      <div id="typing" class="typing"></div>

      <form id="post-form" class="composer">
        {% csrf_token %}
        <input type="hidden" name="username" id="username" value="{{username}}"/>
        <input type="hidden" name="room_id" id="room_id" value="{{room_details.name}}"/>
        <div class="input-field" style="margin-top:6px;">
          <input id="message" name="message" type="text" placeholder="Type a message..." required>
        </div>
        <label for="file" class="upload" title="Attach">
          <span class="material-icons">attach_file</span>
        </label>
        <input id="file" type="file" style="display:none;" accept="image/*,video/*,.pdf,.txt,.doc,.docx">
        <button class="btn btn-primary waves-effect waves-light" type="submit">
          <span class="material-icons" style="vertical-align:middle;">send</span>
        </button>
      </form>
    </section>
  </div>

  <script>
    function initials(name){
      if(!name) return '?';
      const parts = name.trim().split(/\s+/);
      const first = parts[0]?.[0] || '';
      const last = parts.length > 1 ? parts[parts.length-1][0] : (parts[0]?.[1] || '');
      return (first + last).toUpperCase();
    }

    function renderMessages(messages) {
      const container = $("#display");
      container.empty();
      const you = '{{username}}';
      messages.forEach(m => {
        const me = m.user === you;
        const avatarUrl = (window.__avatars && window.__avatars[m.user]) || null;
        const avatarHtml = avatarUrl ? `<img class="avatar" src="${avatarUrl}" alt="${m.user}">` : `<div class="avatar">${initials(m.user)}</div>`;
        let body = '';
        if (m.media_url) {
          if ((m.media_type||'').startsWith('image')) body = `<img class="thumb" src="${m.media_url}" style="max-width:100%; border-radius:12px;"/>`;
          else if ((m.media_type||'').startsWith('video')) body = `<video class="thumb" src="${m.media_url}" style="max-width:100%; border-radius:12px;" controls></video>`;
          else body = `<a href="${m.media_url}" target="_blank">Download file</a>`;
          if (m.value) body = `${m.value}<br/>` + body;
        } else {
          body = m.value;
        }
        const bubbleHtml = `
          <div class="bubble">
            <div class="meta"><span>${m.user}</span><span>${m.date}</span></div>
            <div class="body">${body}</div>
          </div>`;
        const html = me
          ? `<div class="msg me">${bubbleHtml}${avatarHtml}</div>`
          : `<div class="msg">${avatarHtml}${bubbleHtml}</div>`;
        container.append(html);
      });
      container.scrollTop(container.prop("scrollHeight"));
    }

    function renderTyping(users){
      const you = '{{username}}';
      const others = users.filter(u => u !== you);
      if(others.length === 0){ $("#typing").text(""); return; }
      const text = others.length === 1 ? `${others[0]} is typing…` : `${others.length} people are typing…`;
      $("#typing").text(text);
    }

    $(document).ready(function(){
      setInterval(function(){
        $.ajax({ type: 'GET', url : "/getMessages/{{room}}/", success: function(r){ window.__avatars = r.avatars || {}; renderMessages(r.messages); } });
        $.ajax({ type: 'GET', url : "/typing/{{room}}/", success: function(r){ renderTyping(r.typing || []); } });
      }, 1000);

      $(document).on('submit','#post-form',function(e){
        e.preventDefault();
        $.ajax({
          type:'POST',
          url:'/send',
          data:{
            room_id:$('#room_id').val(),
            message:$('#message').val(),
            csrfmiddlewaretoken:$('input[name=csrfmiddlewaretoken]').val(),
          },
          success: function(){
            $('#message').val('');
          }
        });
      });

      // Media upload
      $('#file').on('change', function(){
        const f = this.files[0];
        if(!f) return;
        const fd = new FormData();
        fd.append('file', f);
        fd.append('room_id', $('#room_id').val());
        fd.append('csrfmiddlewaretoken', $('input[name=csrfmiddlewaretoken]').val());
        $.ajax({
          url: '/send_media', method:'POST', data: fd, contentType:false, processData:false,
          success: function(){ $('#file').val(''); },
          error: function(){ alert('Upload failed'); }
        });
      });

      // Typing indicator
      let typingTimer;
      const sendTyping = (on) => {
        $.post('/typing/set/', {
          room_id: $('#room_id').val(),
          is_typing: on ? '1' : '0',
          csrfmiddlewaretoken:$('input[name=csrfmiddlewaretoken]').val(),
        });
      };
      $('#message').on('input', function(){
        clearTimeout(typingTimer);
        sendTyping(true);
        typingTimer = setTimeout(() => sendTyping(false), 1200);
      });

      // Theme toggle with persistence
      const key = 'chat.theme';
      const setTheme = (mode) => {
        if(mode === 'light'){ document.body.classList.add('light'); $('#themeLabel').text('Light'); }
        else { document.body.classList.remove('light'); $('#themeLabel').text('Dark'); }
        localStorage.setItem(key, mode);
      };
      const prefersLight = window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches;
      const saved = localStorage.getItem(key) || (prefersLight ? 'light' : 'dark');
      setTheme(saved);
      $('#themeToggle').on('click', function(){
        const next = document.body.classList.contains('light') ? 'dark' : 'light';
        setTheme(next);
      });
    });
  </script>

  
</body>
</html>